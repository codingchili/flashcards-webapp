<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="/src/flashcards-app/shared-styles.html">
<link rel="import" href="/src/flashcards-app/category-list.html">

<dom-module id="category-view">
    <template>
        <style include="shared-styles"></style>
        <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
      }
      #create-dialog {
        width: 354px;
      }
      #create-button {
        width: 100%;
      }
      #button-group {
        display: block;
        width: 100%;
        margin: 0px;
        padding: 0px;
        right: 0px;
        bottom: 0px;
        position: absolute;
      }
      .cancel-button {
        margin-top: 16px;
      }
      paper-checkbox {
        margin-top: 16px;
      }
      #place-holder {
        width: 232px;
        height: 232px;
        margin: auto;
      }
      #box {
        text-align: center;
        width: 100%;
      }
      .category-box {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        top: 12px;
      }
      .color-picker {
        float: right;
        margin-top: -4px;
      }
      .public-checkbox {
        margin-top: 16px;
        display: inline-block;
        padding-bottom: 104px;
        height: 32px;
        margin-left: 16px;
      }
      .cash-icon {
        width: 16px;
        height: 16px;
      }
        </style>
        <paper-card id="box" elevation="3">
            <div hidden$="[[populated]]">
                <iron-icon id="place-holder" icon="social:sentiment-neutral"></iron-icon>
                <span class="notification">YOU HAVE NOT CREATED ANY CATEGORIES YET.</span>
            </div>

            <category-list id="categories"></category-list>

            <paper-button id="create-button" on-tap="dialog" raised autofocus>Create new</paper-button>
        </paper-card>

        <paper-dialog id="create-dialog" modal>
            <h2>Category options</h2>
            <div style="margin-top:0px;">
                <paper-input label="Name" char-counter maxlength="32" on-keydown="onkey" value="{{category.name}}"
                             autofocus></paper-input>
                <paper-input label="Users" on-keydown="onkey" value="{{category.users}}"></paper-input>
                <paper-input label="Cost" hidden="[[category.shared]]" on-keydown="onkey" value="{{category.cost}}">
                    <div slot="suffix">
                        <iron-icon class="cash-icon" icon="euro-symbol">
                        </iron-icon>
                        <paper-tooltip animation-delay="0" position="bottom">
                            Allow users to buy access, 0 = disabled.
                        </paper-tooltip>
                    </div>
                </paper-input>
                <paper-checkbox checked="{{category.shared}}" class="public-checkbox">Public</paper-checkbox>
                <paper-swatch-picker color="{{category.color}}" class="color-picker" column-count="7"
                                     color-list="[[colors]]">Color
                </paper-swatch-picker>
            </div>
            <div class="buttons" id="button-group">
                <paper-button on-click="create" dialog-confirm raised autofocus>Save</paper-button>
                <paper-button class="cancel-button" dialog-confirm>Cancel</paper-button>
            </div>
        </paper-dialog>

        <iron-ajax id="createjax" url="[[api]]" method="post" body='[[request]]'
                   handle-as="json" on-response="onCreate">
        </iron-ajax>
        <iron-ajax id="listjax" url="[[api]]" method="post" body='[[request]]'
                   handle-as="json" on-response="onList">
        </iron-ajax>
    </template>

</dom-module>

<script>
    class CategoryView extends Polymer.Element {
      static get is() { return 'category-view'; }

      constructor() {
        super();
        this.api = application.api();
        this.populated = false;
        this.colors = application.colors;
        this.clear();

        application.subscribe('authenticated', () => this.list());
      }

      ready() {
        super.ready();
        this.$.categories.onClickHandler((category) => {
            this.category = category;
            this.dialog();
        });
      }

      clear() {
        this.category = {};
        this.category.color = 'var(--secondary-color)';
        this.category.users = [];
        this.category.cost = 0;
      }

      dialog() {
        this.$['create-dialog'].open();
      }

      create() {
       let json = api.request('categories', 'save');
        json.color = this.category.color;
        if (Array.isArray(this.category.users)) {
            json.users = this.category.users;
        } else { // todo tag picker
            json.users = [this.category.users];
        }
        json.shared = this.category.shared;
        json.name = this.category.name;
        json.cost = this.category.cost;
        json.id = this.category.id;

        this.clear();
        this.request = JSON.stringify(json);
        this.$.createjax.generateRequest();
      }

      onCreate(e) {
         let json = e.detail.response;
         console.log(json);
         this.list();
      }

      edit(e) {
        this.category = e.model.item;
        this.dialog();
      }

      list() {
         let json = api.request('categories', 'list');
         this.request = JSON.stringify(json);
         this.$.listjax.generateRequest();
      }

      onList(e) {
        let json = e.detail.response;
        console.log(json);
        this.categories = json.collection;
        this.$.categories.setList(json.collection);

        if (this.categories.length > 0) {
            this.populated = true;
        } else {
            this.populated = false;
        }
      }

      onkey(e) {
        if (e.keyCode == 13) {
            this.create();
            this.$['create-dialog'].close();
        }
      }
    }
    window.customElements.define(CategoryView.is, CategoryView);
</script>
