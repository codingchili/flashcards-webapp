<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<dom-module id="box-search">
    <template>
        <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
      }
      paper-card {
        width: 100%;
        height: 100%;
      }
      paper-input {
        --paper-input-container-focus-color: var(--paper-pink-400);
        --paper-input-container-invalid-color: var(--paper-pink-400);
        --paper-input-container-input-color: #000000;
      }
      #search {
        width: 324px;
        margin-left: auto;
        margin-right: auto;
      }
      #search-hit {
        width: 128px;
        height: 32px;
        font-size: 18px;
        color: rgba(0, 0, 0, 0.4);
      }
      #box {
        height: 90%;
      }

        </style>

        <paper-card id="box" elevation="3">
            <paper-input label="[[name]]" id="search" on-keydown="search" value="{{text}}" autofocus>
                <iron-icon icon="[[icon]]" slot="prefix"></iron-icon>
                <div slot="suffix"></div>
            </paper-input>

            <template is="dom-repeat" items="{{result.collection}}">
                <paper-card id="search-hit">
                    [[item.username]]<br>
                </paper-card>
            </template>
        </paper-card>

        <iron-ajax id="ajax" url="[[api]]" method="post"
                   body='{{json}}'
                   handle-as="json" on-response="response">
        </iron-ajax>

    </template>
    <script>
    class BoxSearch extends Polymer.Element {
      static get is() { return 'box-search'; }
      constructor() {
        super();
        this.api = application.api();
        this.icon = 'apps';
        this.name = 'categories';
        this.text = '';

        application.subscribe('searchType', (event) => {
            this.icon = event.icon;
            this.name = event.name;
            this.$.search.focus();
        });

        application.subscribe('onSearchPage', () => {
            this.$.search.focus();
        });
      }

      search(e) {
          let search = {
            token: application.token,
            username: this.text,
            target: this.name,
            route: 'search'
          };

          this.json = JSON.stringify(search);

          if (this.text.length > 2) {
            this.$.ajax.generateRequest();
            if (e.keyCode == 13) {
                this.text = '';
            }
          }
      }

      response(e) {
        console.log(e.detail.response);
        this.result = e.detail.response;
      }
    }
    window.customElements.define(BoxSearch.is, BoxSearch);

    </script>
</dom-module>
