<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="/src/flashcards-app/shared-styles.html">
<link rel="import" href="/src/flashcards-app/category-list.html">

<dom-module id="category-view">
    <template>
        <style include="shared-styles"></style>
        <style>
            :host {
                display: block;
                width: 100%;
                height: 100%;
            }

            #create-button {
                width: 100%;
            }

            .cancel-button {
                margin-top: 16px;
            }

            paper-checkbox {
                margin-top: 16px;
            }

            #place-holder {
                width: 232px;
                height: 232px;
                margin: auto;
            }

            #box {
                text-align: center;
                width: 100%;
            }

            .color-picker {
                float: right;
                margin-top: -4px;
            }

            .public-checkbox {
                margin-top: 16px;
                display: inline-block;
                height: 32px;
                margin-left: 16px;
            }

            .cash-icon {
                width: 16px;
                height: 16px;
            }

            .menu-list {
                display: flex;
                flex-direction: column;
                padding: 0px;
                margin-top: 32px;
                margin-left: 16px;
                margin-right: 16px;
            }

            .menu-item {
                width: 100%;
                min-height: 64px;
                margin: auto;
                display: flex;
                flex-direction: column;
                text-align: center;
                cursor: pointer;
            }

            .menu-text {
                color: var(--faint-text-color);
            }

            .menu-item:hover {
                border-style: solid;
                border-width: 1px;
                border-color: var(--primary-color);
                box-sizing: border-box;
            }

            .menu-item > iron-icon {
                margin: auto;
                color: var(--primary-color);
            }
        </style>
        <paper-card id="box" elevation="3">
            <div hidden$="[[populated]]">
                <iron-icon id="place-holder" icon="social:sentiment-neutral"></iron-icon>
                <span class="notification">YOU HAVE NOT CREATED ANY CATEGORIES YET.</span>
            </div>

            <div id="toolbar">
                <div class="toolbar-item" on-tap="list">
                    <paper-tooltip animation-delay="0" position="bottom">refresh</paper-tooltip>
                    <iron-icon icon="refresh"></iron-icon>
                </div>
                <div class="toolbar-item" on-tap="createnew">
                    <paper-tooltip animation-delay="0" position="bottom">add new</paper-tooltip>
                    <iron-icon icon="add"></iron-icon>
                </div>

                <div class="toolbar-item" on-tap="search">
                    <paper-tooltip animation-delay="0" position="bottom">search</paper-tooltip>
                    <iron-icon icon="search"></iron-icon>
                </div>
            </div>

            <category-list id="categories"></category-list>
        </paper-card>

        <paper-dialog id="create-dialog" modal>
            <h2>Category options</h2>
            <div style="margin-top:0px;">
                <paper-input label="Name" char-counter maxlength="32" on-keydown="onkey" value="{{category.name}}"
                             autofocus id="nameinput"></paper-input>
                <paper-input label="Users" on-keydown="onkey" value="{{category.users}}"></paper-input>
                <paper-input label="Cost" hidden="[[category.shared]]" on-keydown="onkey" value="{{category.cost}}">
                    <div slot="suffix">
                        <iron-icon class="cash-icon" icon="euro-symbol">
                        </iron-icon>
                        <paper-tooltip animation-delay="0" position="bottom">
                            Allow users to buy access, 0 = disabled.
                        </paper-tooltip>
                    </div>
                </paper-input>
                <paper-checkbox checked="{{category.shared}}" class="public-checkbox">Public</paper-checkbox>
                <paper-swatch-picker color="{{category.color}}" class="color-picker">Color
                </paper-swatch-picker>
            </div>
            <div class="buttons button-group">
                <paper-button on-tap="create" dialog-confirm raised autofocus>Save</paper-button>
                <paper-button class="cancel-button" dialog-confirm>Cancel</paper-button>
            </div>
        </paper-dialog>


        <paper-dialog id="category-dialog" modal>
            <h2>[[category.name]]</h2>
            <div style="margin-top:0px;" class="menu-list">
                <template is="dom-repeat" items="[[category.icons]]" as="icon">
                    <template is="dom-if" if="[[icon.menu]]">
                        <div class="menu-item" on-tap="selected"  dialog-confirm>
                            <iron-icon icon="[[icon.id]]"></iron-icon>
                            <span class="menu-text">[[icon.text]]</span>
                        </div>
                    </template>
                </template>
            </div>
            <div class="buttons button-group">
                <paper-button class="cancel-button" dialog-confirm>Cancel</paper-button>
            </div>
        </paper-dialog>

        <iron-ajax id="createjax" url="[[api]]" method="post" body="[[request]]"
                   handle-as="json" on-response="list">
        </iron-ajax>
        <iron-ajax id="listjax" url="[[api]]" method="post" body="[[request]]"
                   handle-as="json" on-response="onList">
        </iron-ajax>
        <iron-ajax id="deletejax" url="[[api]]" method="post" body="[[request]]"
                   handle-as="json" on-response="onRemove">
        </iron-ajax>
    </template>

</dom-module>

<script>
    class CategoryView extends Polymer.Element {
        static get is() {
            return 'category-view';
        }

        constructor() {
            super();
            this.api = application.api();
            this.populated = false;
            this.clear();

            application.subscribe('authenticated', () => this.list());
        }

        ready() {
            super.ready();
            if (application.authenticated) {
                this.list();
            }

            this.$.categories.onClickHandler((category) => {
                category.icons = this.$.categories.icons(category);
                this.category = category;
                this.$['category-dialog'].open();
            });
        }

        selected(e) {
            let icon = e.model.icon;

            switch (icon.id) {
                case 'remove':
                    this.remove(this.category);
                    break;
                case 'editor:mode-edit':
                    this.edit();
                    break;
                case 'open-in-new':
                    application.publish('openCategory', this.category);
                    break;
            }
        }

        createnew() {
            this.clear();
            this.edit();
        }

        clear() {
            this.category = {};
            this.category.color = 'var(--secondary-color)';
            this.category.users = [];
            this.category.cost = 0;
        }

        edit() {
            this.$['create-dialog'].open();
        }

        create() {
            let json = api.request('categories', 'save');
            json.color = this.category.color;
            if (Array.isArray(this.category.users)) {
                json.users = this.category.users;
            } else { // todo tag picker
                json.users = [this.category.users];
            }
            json.shared = this.category.shared;
            json.name = this.category.name;
            json.cost = this.category.cost;
            json.id = this.category.id;

            this.clear();
            this.request = JSON.stringify(json);
            this.$.createjax.generateRequest();
        }

        remove(category) {
            let json = api.request('categories', 'remove');
            json.id = category.id;
            console.log(json);
            this.request = JSON.stringify(json);
            this.$.deletejax.generateRequest();
        }

        list() {
            let json = api.request('categories', 'list');
            this.request = JSON.stringify(json);
            this.$.listjax.generateRequest();
        }

        onList(e) {
            let json = e.detail.response;
            console.log(json);
            this.categories = json.collection;
            this.$.categories.setList(json.collection);

            if (this.categories.length > 0) {
                this.populated = true;
            } else {
                this.populated = false;
            }
        }

        onRemove(e) {
            let json = e.detail.response;
            console.log(json);
            this.list();
        }

        onkey(e) {
            if (e.keyCode === 13) {
                this.create();
                this.$['create-dialog'].close();
            }
        }

        search() {
            application.publish('route', '/');
        }
    }
    window.customElements.define(CategoryView.is, CategoryView);
</script>
